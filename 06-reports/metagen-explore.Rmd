---
title: "Exploratory microbiome analysis"
output: html_notebook
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
metadata <- readr::read_tsv(here("01-documentation/metadata.tsv"))
analysis_metadata <- readr::read_tsv(here("01-documentation/analysis-metadata.tsv"))
experiment_metadata <- readr::read_tsv(here("01-documentation/experiment-metadata.tsv")) %>%
  filter(`#SampleID` %in% analysis_metadata$`#SampleID`)
bac_properties <- readr::read_tsv(here("01-documentation/species-properties.tsv"))
otu_table_decontam <- readr::read_tsv(here("05-results/post-decontam_taxatable.tsv")) 

# object to order plots by sampling day
day_order <- experiment_metadata %>%
  filter(`#SampleID` %in% analysis_metadata$`#SampleID`) %>%
  #filter(str_detect(`#SampleID`, "SYN")) %>% # only include samples from this study
  arrange(desc(day)) %>% # order by sampling day (ascending)
  .$`#SampleID` # isolate sample names

# my_pallette2 <- c(viridisLite::magma(n = length(top_genus_names)), "grey") 
# names(my_pallette2) <- levels(top_abundance_genus$top_genus)
# my_scale2 <- scale_fill_manual(name = "top_genus", values = my_pallette2)

treatment_colours <- viridisLite::inferno(n = length(unique(experiment_metadata$treatment))) # define pallette and number of colours
env_colours <- viridisLite::magma(n = length(unique(analysis_metadata$Env))) # define pallette and number of colours

experiment_colours <- experiment_metadata %>%
  arrange(desc(day)) %>% 
  mutate(treat_col = case_when(
           treatment == "potato" ~ treatment_colours[1],
           treatment == "wheat" ~ treatment_colours[2],
           treatment == "mix" ~ treatment_colours[3],
           treatment == "control" ~ treatment_colours[4],
           is.na(treatment) ~ "grey"),
         env_col = case_when(
           Env == "saliva" ~ env_colours[5],
           Env == "byoc_calculus" ~ env_colours[1],
           Env == "medium" ~ env_colours[8]
         ))
analysis_colours <- analysis_metadata %>%
  mutate(env_col = case_when(
    Env == "saliva" ~ env_colours[5],
    Env == "byoc_calculus" ~ env_colours[1],
    Env == "subgingival_plaque" ~ env_colours[2],
    Env == "supragingival_plaque" ~ env_colours[3],
    Env == "modern_calculus" ~ env_colours[4]
         ))
```

# Data preparation

Convert to long format and create a column for genus names.

```{r}
# convert decontaminated taxatable to long format
otu_table_long <- otu_table_decontam %>%
  pivot_longer(
    cols = where(is.numeric),
    names_to = "sample",
    values_to = "count"
    ) %>%
  rename(species = `#OTU ID`) %>%
  mutate(genus = str_extract(species, "\\w+"))
```

Convert counts to relative abundance per sample. Separate species and genus levels.

```{r}
species_abund_long <- otu_table_long %>%
  group_by(sample) %>%
  mutate(rel_abund = count / sum(count))

genus_abund_long <- species_abund_long %>%
  group_by(sample, genus) %>%
  summarise(
    count = sum(count),
    rel_abund = sum(rel_abund)
    )

# top 20 common genera in experiment
top_20_genus <- genus_abund_long %>%
  filter(str_detect(sample, "SYN")) %>% 
  ungroup() %>%
  arrange(desc(rel_abund)) %>%
  distinct(genus) %>%
  slice_head(n = 20) %>%
  left_join(genus_abund_long, by = "genus")
```

Combine with bacterial properties.

```{r}
species_properties <- bac_properties %>%
  right_join(species_abund_long, by = "species") %>%
  mutate(abs = if_else(is.na(abs), FALSE, abs))
```


## Colour legends

Env groups.

```{r}
col_seq <- 1:length(levels(as.factor(analysis_colours$env_col)))
qplot(y= col_seq, x = 1, fill=factor(col_seq), geom="tile") +
  scale_fill_manual(values = na.omit(unique(analysis_colours$env_col))) +
  geom_label(aes(label = unique(analysis_colours$Env)[c(3,4,6,5, 2)]), col = "white") +
  theme_void() +
  theme(legend.position="none")
```

Treatment groups.

```{r}
col_seq <- 1:length(levels(as.factor(experiment_colours$treat_col)))
qplot(y= col_seq, x = 1, fill=factor(col_seq), geom="tile") +
  scale_fill_manual(values = na.omit(unique(experiment_colours$treat_col))) +
  geom_label(aes(label = unique(experiment_colours$treatment)), col = "white") +
  theme_void() +
  theme(legend.position="none")
```


# Within the experiment

Plotting relative species abundances across the experiment.

## Genus composition

```{r}
#genus_abund_long
top_20_genus %>% 
  filter(str_detect(sample, "SYN")) %>%
  ggplot(aes(x = sample, y = genus, fill = log(rel_abund))) +
    geom_tile() +
    theme_void() +
    scale_x_discrete(limits = rev(day_order)) + # reverse day_order vector
    #my_scale2 +
    theme(
      axis.text = element_text(),
      axis.text.x = element_text(
        angle = 45,
        hjust = 1,
        vjust = 1,
        colour = rev(experiment_colours$env_col)
        )) +
    scale_fill_viridis_c(option = "B")

genus_abund_long %>%
  filter(str_detect(sample, "SYN")) %>% 
  mutate(top_genus = case_when(rel_abund > 0.01 ~ genus,
                               TRUE ~ NA_character_)) %>% 
  ggplot(aes(x = rel_abund, y = sample, fill = top_genus)) +
    geom_col() +
    theme_void() +
    scale_y_discrete(limits = day_order) +
    #my_scale2 +
    theme(
      axis.text.y = element_text(colour = experiment_colours$env_col)) +
    scale_fill_viridis_d(option = "D")
```



## Species composition

Only including the name of the top 10 species (relative abundance) within each
sample. Remaining species are designated as 'other'.


```{r}
 # label all species below top 10 as 'other' so the rel_abund still sums to 1 for plotting


# Plot colours
# my_pallette <- c(viridisLite::plasma(n = length(top_species_names)), "grey") 
# names(my_pallette) <- levels(top_abundance_species$top_species)
# my_scale <- scale_fill_manual(name = "top_species", values = my_pallette)
# 
# # Plot colours
# species_colours_sample <- top_abundance_species %>% 
#   filter(str_detect(sample, "SYN")) %>%
#   mutate(top_species = as.character(top_species)) %>% 
#   .$top_species %>%
#   unique()
# my_pallette <- c(viridisLite::plasma(n = length(species_colours_sample) - 1), "grey") 
# names(my_pallette) <- c(species_colours_sample[which(species_colours_sample != "other")], "other")
# my_scale <- scale_fill_manual(name = "top_species", values = my_pallette)
# 
# top_abundance_species %>%
#   filter(str_detect(sample, "SYN")) %>%
#   #arrange(day) %>%
#   ggplot(aes(x = rel_abund, y = sample, fill = top_species)) +
#     geom_col() +
#     theme_void() +
#     scale_y_discrete(limits = day_order) +
#     my_scale +
#     theme(axis.text = element_text())

species_abund_long %>%
  filter(str_detect(sample, "SYN")) %>% 
  mutate(top_species = case_when(rel_abund > 0.05 ~ species,
                               TRUE ~ NA_character_)) %>% 
  ggplot(aes(x = rel_abund, y = sample, fill = top_species)) +
    geom_col() +
    theme_void() +
    scale_y_discrete(limits = day_order) +
    #my_scale2 +
    theme(axis.text = element_text())
```

### Oxygen tolerance

```{r}
no_match <- unique(filter(species_properties, is.na(`Oxygen tolerance`))$species) # which species had no match?
```

Proportional distribution of oxygen tolerances across experimental samples.
Data on oxygen tolerance obtained from [BacDive](https://bacdive.dsmz.de/).
A total of **`r length(no_match)`** out of
**`r length(unique(species_abund_long$species))`**
(`r scales::percent(length(no_match) / length(unique(species_abund_long$species)), accuracy = 0.1)`)
species did not have a match on BacDive.

```{r}
species_properties %>% 
  filter(str_detect(sample, "SYN")) %>% 
  ggplot(aes(y = sample, x = rel_abund, fill = `Oxygen tolerance`)) +
    geom_col() +
    theme_minimal() +
    #theme(axis.text.x = element_text(angle = 90)) +
    scale_y_discrete(limits = day_order) +
    scale_fill_manual(
      values = viridisLite::turbo(n = length(levels(as.factor(species_properties$`Oxygen tolerance`)))))
```

Generally an increase of anaerobes over the course of the experiment, at the
expense of facultative anaerobes. Low proportion of aerobes throughout the
experiment.

### Amylase-binding species

Relative abundance of ABS per sample. Different treatments indicated by text colour.

```{r}
species_properties %>% 
  filter(str_detect(sample, "SYN")) %>%#,
         #str_detect(sample, "SYN00[1-3]", negate = T)) %>% 
  ggplot(aes(y = sample, x = rel_abund, fill = abs)) +
    geom_col() +
    theme_minimal() +
    #theme(axis.text.x = element_text(angle = 90)) +
    scale_y_discrete(limits = day_order) +
    scale_fill_manual(
      values = viridisLite::cividis(n = 2)) +
    theme(
      axis.text.y = element_text(
        colour = experiment_colours %>%
          arrange(desc(day)) %>%
          .$treat_col))
```

```{r}
analysis_metadata %>%
  filter(str_detect(`#SampleID`, "SYN")) %>% 
  dplyr::select(`#SampleID`, treatment)
```

The presence of ABS was unrelated to the presence of starch. The overall proportion
of ABS decreases over the course of the experiment. The absence of amylase in
the model may reduce the need for species capable of starch hydrolysis, especially
when sucrose was available in all samples.

# Comparative samples

Looking at relative abundances at species and genus level. Artificial calculus samples only
(i.e. day 24 of experiment) were compared with reference plaque and calculus samples.

## Genus composition

Top 4 most abundant genera in each sample are selected to provide a manageable
overview of sample composition.

Top 10 most abundant species are selected to provide a manageable overview.
Species outside of the top 10 are labeled 'other'.

## Species composition


### Oxygen tolerance

Proportional distribution of oxygen tolerance across artificial calculus and
comparative samples.

```{r}
species_properties %>% 
  filter(str_detect(sample, "SYN[0-9]*.[A-H]", negate = T)) %>% 
  ggplot(aes(y = sample, x = rel_abund, fill = `Oxygen tolerance`)) +
    geom_col() +
    scale_fill_viridis_d() +
    theme_minimal()
    #theme(axis.text.x = element_text(angle = 90)) +
```
### Amylase-binding species

```{r}
species_properties %>% 
  filter(str_detect(sample, "SYN[0-9]*.[A-H]", negate = T)) %>% 
  ggplot(aes(y = sample, x = rel_abund, fill = abs)) +
    geom_col() +
    theme_minimal() +
    scale_fill_viridis_d()
    #theme(axis.text.x = element_text(angle = 90)) +
```

Amylase-binding species are seemingly underrepresented in the artificial calculus
samples compared to the comparative samples.

