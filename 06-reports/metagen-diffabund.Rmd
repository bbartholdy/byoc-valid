---
title: "Differential abundance"
output: html_notebook
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
library(phyloseq)
library(microbiome)
library(ANCOMBC)
taxatable <- readr::read_tsv("05-results/post-decontam_taxatable.tsv")
analysis_metadata <- readr::read_tsv("01-documentation/analysis-metadata.tsv")
experiment_metadata <- readr::read_tsv("01-documentation/experiment-metadata.tsv")
```

Data are converted to `phyloseq` format.

```{r}
# otu_table_long <- taxatable %>%
#   pivot_longer(cols = where(is.numeric), names_to = "sample", values_to = "count")

# taxatable %>%
#   column_to_rownames(var = "#OTU ID") %>% 
#   otu_table(taxa_are_rows = T)

calculus_matrix <- taxatable %>%
  column_to_rownames(var = "#OTU ID") %>% 
  select(which(
    colnames(.) %in% filter(
      analysis_metadata, str_detect(Env, "calculus|plaque"))$`#SampleID`
  ))

experiment_otu <- taxatable %>%
  column_to_rownames(var = "#OTU ID") %>% 
  select(which(
    colnames(.) %in% experiment_metadata$`#SampleID` & 
      colnames(.) %in% analysis_metadata$`#SampleID`)) %>%
  otu_table(taxa_are_rows = T)

experiment_meta <- experiment_metadata %>%
  filter(`#SampleID` %in% analysis_metadata$`#SampleID`) %>%
  column_to_rownames(var = "#SampleID") %>% 
  sample_data()

experiment_phyloseq <- phyloseq(experiment_otu, experiment_meta)
```

```{r}
# phyloseq object for experiment samples
metadata %>%
  filter(SourceSink == "sink")

# phyloseq object to compare calculus samples
```

