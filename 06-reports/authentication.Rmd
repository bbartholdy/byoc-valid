---
title: "Authentication"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_knit$set(message = FALSE)
library(here)
```

Load necessary packages.

```{r}
#| label: dependencies
library(cuperdec)
library(decontam)
library(here)
library(tidyverse)
```

Upload the data and metadata.

```{r}
#| label: data-upload
# upload data
lib_conc <- readr::read_tsv(here("01-documentation/SYN_library_quant.tsv")) # library concentrations
kraken_taxatab <- readr::read_csv(here("04-analysis/OTUfilter_table.tsv"))
sourcetracker2 <- readr::read_tsv(here("04-analysis/sourcetracker/sourcetracker2_output/mixing_proportions.txt"))
sourcetracker2_stdevs <- readr::read_tsv(here("04-analysis/sourcetracker/sourcetracker2_output/mixing_proportions_stds.txt")) 
sourcetracker2.2 <- readr::read_tsv(here("04-analysis/sourcetracker/sourcetracker2_output2/mixing_proportions.txt"))
sourcetracker2.2_stdevs <- readr::read_tsv(here("04-analysis/sourcetracker/sourcetracker2_output2/mixing_proportions_stds.txt")) 
metadata <- readr::read_tsv(here("01-documentation/metadata.tsv"))

sourcetracker2_long <- sourcetracker2 %>%
  pivot_longer(cols = where(is.numeric), 
               values_to = "proportion", 
               names_to = "SampleID") %>%
  rename(source = ...1)

sourcetracker2.2_long <- sourcetracker2.2 %>%
  pivot_longer(cols = where(is.numeric), 
               values_to = "proportion", 
               names_to = "SampleID") %>%
  rename(source = ...1)

# kraken_taxatab <- readr::read_csv(here("03-data/taxa_table.csv"))
# metadata <- readr::read_csv(here("03-data/sample_metadata.csv"))
# file_names <- list.files(here("03-data/kraken/"), "_report")
# sample_names <- gsub(".unmapped.*", "", file_names)
# 
# metadata$sample[-1] <- paste0(metadata$sample[-1], "0101") # match metadata names to sequence names
# metadata <- subset(metadata, metadata$sample %in% sample_names) # subset successful sequences (?)
```

## SourceTracker

Steps taken for SourceTracker analysis.

OTU table was filtered for relative abundance. Percent abundance of each taxon
across all samples was calculated and then taxa with lower than 0.001% abundance
were filtered out. See [data prep script](../02-scripts/01-dataprep.R).

Installation of Qiime2 and dev version of SourceTracker via conda:

```sh
wget https://data.qiime2.org/distro/core/qiime2-2022.2-py38-linux-conda.yml
conda env create -n qiime2-2022.2 --file qiime2-2022.2-py38-linux-conda.yml
rm qiime2-2022.2-py38-linux-conda.yml # cleanup
conda activate qiime2-2022.2
pip install https://github.com/biota/sourcetracker2/archive/master.zip
```

Installation of Qiime1 to access filter_samples_from_otu_table.py

```sh
conda create -n qiime1 python=2.7 qiime -c bioconda
```

Convert OTU table from *.tsv* to *.biom*.

```sh
biom convert -i 04-analysis/OTUfilter_table.tsv -o 04-analysis/sourcetracker/OTUfilter-table-from-tsv_json.biom --table-type="OTU table" --to-json
```

Filter OTU table

```sh
filter_samples_from_otu_table.py \
-i 04-analysis/sourcetracker/OTUfilter-table-from-tsv_json.biom \
-o 04-analysis/sourcetracker/OTUs1000filter_table.biom \
-n 1000
```

Table summary

```sh
biom summarize-table -i 04-analysis/sourcetracker/OTUs1000filter_table.biom > 04-analysis/sourcetracker/summary_OTUs1000filter-table.txt
```

Run SourceTracker 2 on the filtered OTU table with rarefaction depth of 10000
for both source and samples. Samples and sources were mapped in the
[ST_comb-plaque-map.txt](../04-analysis/sourcetracker/ST_comb-plaque-map.txt).
The plaque source is a combination of supragingival and subgingival plaque.

```sh
conda activate qiime2-2022.2
```

```sh
sourcetracker2 \
  -i 04-analysis/sourcetracker/OTUs1000filter_table.biom \     
  -m 04-analysis/sourcetracker/ST_comb-plaque-map.txt \     
  --source_sink_column SourceSink \
  --source_column_value source \
  --source_rarefaction_depth 10000 \
  --sink_rarefaction_depth 10000 \
  --sink_column_value sink \
  --source_category_column Env \
  -o 04-analysis/sourcetracker/sourcetracker2_output \
  --jobs 2 \
  --per_sink_feature_assignments
```

The full results can be found in [04-analysis/sourcetracker/sourcetracker2_output](../04-analysis/sourcetracker/sourcetracker2_output/)

Another run with indoor_air sources included and sediment removed

```sh
sourcetracker2 \
    -i 04-analysis/sourcetracker/OTUs1000filter_table.biom \
    -m 04-analysis/sourcetracker/ST_no-sedi.txt \
    --source_sink_column SourceSink  \
    --source_column_value source \
    --source_rarefaction_depth 1000 \
    --sink_rarefaction_depth 1000 \
    --sink_column_value sink \
    --source_category_column Env \
    -o 04-analysis/sourcetracker/sourcetracker2_output2 \
    --jobs 2 \
    --per_sink_feature_assignments
```

The full results can be found in [04-analysis/sourcetracker/sourcetracker2_output](../04-analysis/sourcetracker/sourcetracker2_output2/)

### Visualisation of sources

To help visualise samples by the sequence in which they were sampling during the
experiment, the samples were organised by day they were sampled.

```{r}
day_order <- metadata %>%
  filter(SourceSink == "sink") %>%
  arrange(day) %>%
  filter(`#SampleID` %in% colnames(sourcetracker2)) %>%
  .$`#SampleID`
```


```{r}
#| label: st-plot
#| fig-cap: "Plot of estimated contributions of various sources to the artificial calculus and artificial saliva samples. Samples are arranged from left to right by how late in the experiment they were sampled, with left being the earliest samples."
sourcetracker2_long %>% 
  ggplot(aes(SampleID, proportion, fill = source)) +
    geom_col() +
    scale_fill_viridis_d() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90)) +
    scale_x_discrete(limits = day_order) +
    scale_fill_viridis_d()
```

Figure \@ref(fig:st-plot) shows that a lot of species were assigned to the
'Unknown' category. To see whether this was the result of external contamination
or the presence of oral taxa with an unknown origin (which could be due to the
taxa matching multiple sources), the taxa from 'Unknown' were compared to the
oral reference database from the **cuperdec** R package. Only samples with a
large proportion of 'Unknowns' (>50%) were included.

```{r}
#| label: unknowns-plot
#| fig-cap: "Plot with the origin of 'Unknown' taxa within problematic samples."
all_data_long %>% 
  filter(count > 0) %>% 
  mutate(oral_source = if_else(taxon %in% oral_taxa$Taxon, "oral", "other")) %>%
  ggplot(aes(x = SampleID, y = count, fill = oral_source)) +
    geom_col(position = "fill") +
    scale_fill_viridis_d() +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 90)) +
    scale_x_discrete(limits = day_order)
```

Figure \@ref(fig:unknowns-plot) shows that a small proportion of the species
assigned to 'Unknown' are known to be oral taxa. The samples do also seem to
contain some external contamination.

Based on the results from SourceTracker, samples ... were removed from the analysis.

## Cuperdec

```{r}
head(kraken_taxatab) %>%
  select(1:5) %>%
  knitr::kable()
```

```{r}
head(metadata) %>%
  select(sample, source) %>%
  knitr::kable()
```

```{r}
taxa_table <- load_taxa_table(kraken_taxatab)
iso_database <- load_database(cuperdec_database_ex, target = "oral")
metadata_table <- load_map(metadata,
                           sample_col = "sample",
                           source_col = "source"
                           )

curves <- calculate_curve(taxa_table, iso_database)
filter_result <- simple_filter(curves, 60)
```

```{r}
plot_cuperdec(curves, metadata_table, filter_result)
```
